{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block content %}
<style>
  /* ERPNext-inspired styling */
  .erpnext-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .page-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e8e9ec;
  }

  .page-title {
    font-size: 24px;
    font-weight: 600;
    color: #1f272e;
    margin: 0 0 8px 0;
  }

  .page-subtitle {
    font-size: 14px;
    color: #6c757d;
    margin: 0;
  }

  .card {
    background: #ffffff;
    border: 1px solid #e8e9ec;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
  }

  .card-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f272e;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title-icon {
    width: 20px;
    height: 20px;
    color: #6c757d;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #3c4149;
    margin-bottom: 8px;
  }

  .form-control {
    width: 100%;
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #d1d8dd;
    border-radius: 6px;
    background: #ffffff;
    transition: all 0.2s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: #2490ef;
    box-shadow: 0 0 0 3px rgba(36, 144, 239, 0.1);
  }

  .form-control-color {
    height: 42px;
    width: 80px;
    padding: 4px;
    cursor: pointer;
  }

  .color-picker-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .color-value-display {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    color: #495057;
    padding: 8px 12px;
    background: #f8f9fa;
    border: 1px solid #d1d8dd;
    border-radius: 6px;
    min-width: 90px;
  }

  .btn {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 6px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: #2490ef;
    color: #ffffff;
    border-color: #2490ef;
  }

  .btn-primary:hover {
    background: #1a7bd6;
    border-color: #1a7bd6;
  }

  .btn-secondary {
    background: #6c757d;
    color: #ffffff;
    border-color: #6c757d;
  }

  .btn-secondary:hover {
    background: #5a6268;
  }

  .code-box {
    position: relative;
    background: #f8f9fa;
    border: 1px solid #e8e9ec;
    border-radius: 6px;
    padding: 16px;
    margin-top: 12px;
  }

  .code-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    color: #2c3e50;
    white-space: pre-wrap;
    word-break: break-all;
    margin: 0;
    line-height: 1.6;
  }

  .copy-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 6px 12px;
    font-size: 12px;
    background: #ffffff;
    border: 1px solid #d1d8dd;
    color: #495057;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .copy-btn:hover {
    background: #f8f9fa;
    border-color: #2490ef;
    color: #2490ef;
  }

  .copy-btn.copied {
    background: #28a745;
    border-color: #28a745;
    color: #ffffff;
  }

  .preview-box {
    background: #ffffff;
    border: 2px dashed #d1d8dd;
    border-radius: 8px;
    padding: 32px;
    margin-top: 12px;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .alert-info {
    background: #e7f3ff;
    border: 1px solid #b8daff;
    color: #004085;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 12px;
    background: #e7f3ff;
    color: #2490ef;
  }

  @media (max-width: 768px) {
    .erpnext-container {
      padding: 16px;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="erpnext-container">

  <!-- Customization Card -->
  <div class="card">
    <h2 class="card-title">
      <svg class="card-title-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
      </svg>
      Widget Settings
    </h2>

    <form id="snippet-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="botName" class="form-label">Bot Name</label>
          <input type="text" id="botName" class="form-control" value="{{ bot_name }}" placeholder="Enter bot name">
        </div>

        <div class="form-group">
          <label for="primaryColor" class="form-label">Primary Color</label>
          <input type="color" id="primaryColor" class="form-control form-control-color" value="{{ color }}">
        </div>
      </div>

      <div class="alert alert-info">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
        <span>Changes are automatically saved. Click "Reload Preview" to see updates in the live widget.</span>
      </div>

      <button type="button" id="reload-btn" class="btn btn-primary">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
        </svg>
        Reload Preview
      </button>
    </form>
  </div>

  <!-- Embed Code Card -->
  <div class="card">
    <h2 class="card-title">
      <svg class="card-title-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
      </svg>
      Embed Code
      <span class="badge">Copy & Paste</span>
    </h2>

    <div class="code-box">
      <code id="snippet-display" class="code-content"></code>
      <button id="copy-btn" class="copy-btn">Copy</button>
    </div>
  </div>

  <!-- Live Preview Card -->
    <div id="widget-preview-area">
      <!-- Widget will be injected here -->
    </div>
</div>

<script>
(function(){
  const studentId = "{{ student_id|escapejs }}";
  const baseUrl = "{{ base_url|escapejs }}";
  const botInput = document.getElementById('botName');
  const colorInput = document.getElementById('primaryColor');
  const display = document.getElementById('snippet-display');
  const copyBtn = document.getElementById('copy-btn');
  const widgetArea = document.getElementById('widget-preview-area');
  const reloadBtn = document.getElementById('reload-btn');

  function escapeAttr(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function updateSnippetAndPreview() {
    const bot = botInput.value || '';
    const color = colorInput.value || '';
    const botEsc = escapeAttr(bot);
    const colorEsc = escapeAttr(color);
    const studEsc = escapeAttr(studentId);

    const raw = '<script src="' + baseUrl + 'widget" '
      + 'data-api-url="' + baseUrl + 'ID/' + studEsc + '" '
      + 'data-bot-name="' + botEsc + '" '
      + 'data-primary-color="' + colorEsc + '"></scr' + 'ipt>';

    display.textContent = raw;
    copyBtn.dataset.raw = raw;

    // Update live preview
    widgetArea.innerHTML = '';
    const script = document.createElement('script');
    script.src = baseUrl + 'widget';
    script.dataset.apiUrl = baseUrl + 'ID/' + studentId;
    script.dataset.botName = bot;
    script.dataset.primaryColor = color;
    widgetArea.appendChild(script);
  }

  function saveCustomization() {
    const botName = botInput.value;
    const color = colorInput.value;

    fetch("{% url 'save_bot_customization' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie('csrftoken'),
      },
      body: JSON.stringify({
        bot_name: botName,
        color: color
      })
    })
    .then(response => response.json())
    .then(data => {
      if (!data.success) console.error("Save failed:", data.error);
    })
    .catch(err => console.error("Save error:", err));
  }

  let saveTimer;
  function scheduleAutoSave() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      saveCustomization();
      updateSnippetAndPreview();
    }, 600);
  }

  copyBtn.addEventListener('click', function() {
    const raw = this.dataset.raw || '';
    navigator.clipboard.writeText(raw).then(() => {
      this.classList.add('copied');
      this.innerText = '✓ Copied!';
      setTimeout(() => {
        this.classList.remove('copied');
        this.innerText = 'Copy';
      }, 2000);
    }).catch(err => alert('Copy failed: ' + err));
  });

  botInput.addEventListener('input', scheduleAutoSave);
  colorInput.addEventListener('input', scheduleAutoSave);

  reloadBtn.addEventListener('click', function() {
    location.reload();
  });

  // Initialize
  updateSnippetAndPreview();
})();
</script>
{% endblock %}